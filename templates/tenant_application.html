<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tenant Information Form</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;600&display=swap">
</head>
<body>
<div class="container form">
  <h2>Tenant Application Form</h2>
  <form id="tenant-application-form" method="POST" class="needs-validation" novalidate>

    <!-- Page 1 -->
    <div class="form-page" id="page1">
        <div class="mb-3">
          <label for="FullName" class="form-label">Full Name:</label>
          <!-- <small class="form-text text-muted">Please provide your first name, middle name (if applicable), and last name.</small> -->
          <input type="text" class="form-control" id="FullName" name="FullName" required>
        </div>
        <div class="mb-3">
          <label for="TenantAddress" class="form-label">Address of flat you are applying for:</label>
          <small class="form-text text-muted">Please provide the flat letter and street address of the Bitprop flat you are applying for.</small>
          <input type="text" class="form-control" id="TenantAddress" name="TenantAddress" required>
        </div>
        <div class="mb-3">
          <label for="PrimaryContactNumber" class="form-label">Primary Contact Number:</label>
          <input type="text" class="form-control" id="PrimaryContactNumber" name="PrimaryContactNumber" pattern="0[0-9]{9}" placeholder="0123456789" required inputmode="numeric" minlength="10" maxlength="10">
        </div>
        <div class="mb-3">
          <label for="IdNumber" class="form-label">ID Number:</label>
          <input type="text" class="form-control" id="IdNumber" name="IdNumber" required inputmode="numeric">
        </div>
        <div class="mb-3">
          <label for="EmailAddress" class="form-label">Email Address:</label>
          <input type="Email" class="form-control" id="EmailAddress" name="EmailAddress" required>
        </div>
        <button type="button" id="next1" class="btn btn-primary">Next</button>
        <br><br>
        <div class="progress-container">
          <div class="progress-bar" id="progressBarPage1"></div>
        </div>
        <div class="page-counter" id="pageCounter1"></div>
      </div>
    
    <!-- Page 2: Employment & Household Information -->
<div class="form-page" id="page2" style="display:none;">
    <div class="mb-3">
      <label for="JobTitleOrEmploymentStatus" class="form-label">Job Title / Employment Status:</label>
      <input type="text" class="form-control" id="JobTitleOrEmploymentStatus" name="JobTitleOrEmploymentStatus" required>
    </div>
    <div class="mb-3">
      <label for="IncomeBracket" class="form-label">Income Bracket:</label>
      <select class="form-control" id="IncomeBracket" name="IncomeBracket" required>
        <option value="">Select</option>
        <option value="R0-R2000">R0-R2000</option>
        <option value="R2000-R5000">R2000-R5000</option>
        <option value="R5000-R10000">R5000-R10000</option>
        <option value="R0-R2000">R10000-R15000</option>
        <option value="R2000-R5000">R15000-R25000</option>
        <option value="R5000-R10000">R25000 and above</option>
        <!-- ... other options ... -->
      </select>
    </div>
    <div class="mb-3">
      <label for="NumberOfPeopleInFlat" class="form-label">How many people will live in the flat including you?</label>
      <input type="number" class="form-control" id="NumberOfPeopleInFlat" name="NumberOfPeopleInFlat" required>
    </div>
    <div class="mb-3">
      <label for="DistributionOfTenantsBySetup" class="form-label">Distribution of tenants by setup:</label>
      <select class="form-control" id="DistributionOfTenantsBySetup" name="DistributionOfTenantsBySetup" required>
        <option value="">Select</option>
        <option value="single">Single</option>
        <option value="couple">Couple</option>
        <option value="single">Single Parent</option>
        <option value="couple">Family</option>
        <!-- ... other options ... -->
      </select>
    </div>
    <button type="button" onclick="prevPage(1)" class="btn btn-secondary">Previous</button>
    <button type="button"id="next2" class="btn btn-primary">Next</button>
    <br><br>
    <div class="progress-container">
      <div class="progress-bar" id="progressBarPage2"></div>
    </div>
    <div class="page-counter" id="pageCounter2"></div>
  </div>
  
    <!-- Page 3: Previous Housing & References -->
    <div class="form-page" id="page3" style="display:none;">
        <div class="mb-3">
          <label for="PreviousDwellingType" class="form-label">What sort of dwelling are you currently living in?</label>
          <select class="form-control" id="PreviousDwellingType" name="PreviousDwellingType" required>
            <option value="">Select</option>
            <option value="flat">Flat</option>
            <option value="house">House</option>
            <option value="studentHousing">Student Housing</option>
            <option value="informalDwelling">Informal Dwellling</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="mb-3">
            <label for="PreviousResidence" class="form-label">What area are you currently living in?</label>
            <small class="form-text text-muted">Provide area/suburb/city/country etc.</small>
            <input type="text" class="form-control" id="PreviousResidence" name="PreviousResidence" required>
        </div>
        <div class="mb-3">
          <label for="RentalHistory" class="form-label">Rental History: Have you rented a property before? If yes, please provide details of your most recent rental experience.</label>
          <textarea class="form-control" id="RentalHistory" name="RentalHistory" rows="3" placeholder="For example, I stayed in a share-house and I enjoyed it because my room received a lot of light throughout the day." required></textarea>
        </div>
        <br>
        <div class="mb-3">
            <label for="PreviousArea" class="form-label" style="font-weight: bold;">Please select Yes or No for each of the following questions:</label>
        </div>
        <div class="mb-3">
            <label for="UnderstandsTermsAndConditions" class="form-label">I have a clear understanding of the terms and conditions outlined in my lease agreement.</label><br>
            <input type="radio" id="leaseUnderstandingYes" name="UnderstandsTermsAndConditions" value="yes" onclick="toggleTextBox(false)" required>
            <label for="leaseUnderstandingYes">Yes</label><br>
            <input type="radio" id="leaseUnderstandingNo" name="UnderstandsTermsAndConditions" value="no" onclick="toggleTextBox(true)" required>
            <label for="leaseUnderstandingNo">No</label>
        </div>
        <div id="textBoxDiv" style="display:none; margin-top:10px; margin-bottom:10px;">
            <label for="UnderstandingMoreInfo">Please provide more information:</label><br>
            <textarea id="UnderstandingMoreInfo" name="UnderstandingMoreInfo" rows="4" cols="50"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label" for="AwareOfResponsibilities">Are you aware of your responsibilities for general maintenance and upkeep of the Bitprop flat?</label><br>
            <input type="radio" id="MaintenanceResponsibilityYes" name="AwareOfResponsibilities" value="yes" onclick="toggleMaintenanceTextBox(false)" required>
            <label for="MaintenanceResponsibilityYes">Yes</label><br>
            <input type="radio" id="MaintenanceResponsibilityNo" name="AwareOfResponsibilities" value="no" onclick="toggleMaintenanceTextBox(true)" required>
            <label for="MaintenanceResponsibilityNo">No</label>
        </div>
        <div id="maintenanceTextBoxDiv" style="display:none; margin-top:10px; margin-bottom:10px;">
            <label for="MaintenanceMoreInfo">Please provide more information:</label><br>
            <textarea id="MaintenanceMoreInfo" name="MaintenanceMoreInfo" rows="4" cols="50"></textarea>
        </div>
        <input type="hidden" id="currentDate" name="date" value="">
        
        <!-- <div class="mb-3">
          <label for="references" class="form-label">Can you provide references?</label>
          <input type="checkbox" id="references" name="references" required>
          <label for="references">Yes</label>
        </div>
        <div class="mb-3">
          <label for="numReferences" class="form-label">How many references can you provide?</label>
          <input type="number" class="form-control" id="numReferences" name="numReferences" required>
        </div> -->
        <button type="button" onclick="prevPage(2)" class="btn btn-secondary">Previous</button>
        <button type="submit" id="submit" class="btn btn-primary">Submit</button>
        <br><br>
        <div class="progress-container">
          <div class="progress-bar" id="progressBarPage3"></div>
        </div>
        <div class="page-counter" id="pageCounter3"></div>
      </div>

  </form>
</div>


<script>

    // Function to initialize the form with page 1 displayed
    function init() {
        nextPage(1);
    }

    // Run the init function when the document is fully loaded
    window.onload = init;

    function validatePage(pageNumber) {
        console.log('validatePage called for page ', pageNumber);
        // Use conditions to apply different validations based on the page number
        if (pageNumber === 1) {
          if (!validateTextInput('FullName') ||
            !validateTextInput('TenantAddress') ||
            !validatePhone('PrimaryContactNumber') ||
            !validateTextInput('EmailAddress')
          ) {
            return false;
          } else {
            return true;
          }
        } else if (pageNumber === 2) {
          if (!validateTextInput('JobTitleOrEmploymentStatus') ||
          !validateDropdown('IncomeBracket') ||
          !validateNumber('NumberOfPeopleInFlat') ||
          !validateDropdown('DistributionOfTenantsBySetup')
          ) {
            return false;
          } else {
            return true;
          }
        } else if (pageNumber === 3) {
          if (!validateTextInput('RentalHistory') ||
          !validateDropdown('PreviousDwellingType') ||
          !validateTextInput('PreviousResidence') ||
          !validateRadioInput('UnderstandsTermsAndConditions') ||
          !validateRadioInput('AwareOfResponsibilities')
          ) {
            return false;
          } else {
            return true;
          }
        }

    }


    function validateTextInput(id) {
        const input = document.getElementById(id);
        if(input.value.trim() === "") {
            input.style.borderColor = 'red';
            return false;
        } else {
            input.style.borderColor = '';
            return true;
        }
    }

    function validatePhone(id) {
        const phoneInput = document.getElementById(id);
        if (phoneInput.value.length !== 10 || phoneInput.value[0] !== '0') {
          phoneInput.style.borderColor = 'red';
          return false;
        } else {
          phoneInput.style.borderColor = '';
          return true;
        }
    }
  

    function validateRadioInput(name) {
        const radios = document.getElementsByName(name);
        for(let i = 0; i < radios.length; i++) {
            if(radios[i].checked) {
                return true;
            }
        }
        alert('Please answer all questions before proceeding.');
        return false;
    }

    function validateDropdown(dropdownId) {
        // Get the dropdown element by its ID
        const dropdown = document.getElementById(dropdownId);

        // Get the selected index and value
        const selectedIndex = dropdown.selectedIndex;
        console.log('selected index:', selectedIndex);
        const selectedValue = dropdown.options[selectedIndex].value;
        console.log('selectedvalue:', selectedValue);

        // Validate the selected value
        if (selectedValue === "" || selectedValue === "PlaceholderValue" /* or any invalid value */) {
            // Optionally: Provide a visual cue for invalid selection
            dropdown.style.borderColor = 'red';
            console.log('validate dropdown false');
            return false; // Invalid selection
        } else {
            dropdown.style.borderColor = ''; // Reset border color
            console.log('validate dropdown true');
            return true; // Valid selection
        }
    }
    let min = 0;
    let max = 100;
    function validateNumber(inputId, min, max) {
        // Get the input element by its ID
        const numberInput = document.getElementById(inputId);

        // Get the input value and parse it as a number
        const numberValue = parseInt(numberInput.value, 10);

        // Validate the number value
        if (isNaN(numberValue) || numberValue < min || numberValue > max) {
            // Optionally: Provide a visual cue for invalid input
            numberInput.style.borderColor = 'red';
            return false; // Invalid number input
        } else {
            numberInput.style.borderColor = ''; // Reset border color
            return true; // Valid number input
        }
    }



    function nextPage(pageNumber) {
      var phoneInput = document.getElementById('PrimaryContactNumber');
      phoneInput.style.borderColor = '';
      // if (pageNumber === 1 && (phoneInput.value.length !== 10)) {
      //   phoneInput.style.borderColor = 'red';
      //   return;
      // }
        // Hide all pages
        document.querySelectorAll('.form-page').forEach(function(page) {
        page.style.display = 'none';
        });
        // Show the specified page
        document.getElementById('page' + pageNumber).style.display = 'block';

        // Update progress bar
        var progressBar = document.getElementById('progressBarPage' + pageNumber);
        if (progressBar) {
          var width = (pageNumber / 8) * 100;
          progressBar.style.width = width + '%';
        }

        // Update page counter
        var pageCounter = document.getElementById('pageCounter' + pageNumber);
        if (pageCounter) {
          pageCounter.innerText = 'Page ' + pageNumber + '/' + 8;
        }

        window.scrollTo(0, 0);
    }
    
    function prevPage(pageNumber) {
    // Hide all pages
    document.querySelectorAll('.form-page').forEach(function(page) {
        page.style.display = 'none';
    });
    // Show the specified previous page
    document.getElementById('page' + pageNumber).style.display = 'block';
    window.scrollTo(0, 0);
    }

    function toggleTextBox(shouldShow) {
        const textBoxDiv = document.getElementById('textBoxDiv');
        textBoxDiv.style.display = shouldShow ? 'block' : 'none';
    }

    function toggleMaintenanceTextBox(shouldShow) {
        const maintenanceTextBoxDiv = document.getElementById('maintenanceTextBoxDiv');
        maintenanceTextBoxDiv.style.display = shouldShow ? 'block' : 'none';
    }

    function handleSubmit() {
      // You may want to do form validation here

      // After successful validation and form submission to the server
      window.location.href = 'tenant_application_confirmation.html';
      return false; // Prevent the form from submitting the traditional way
    } 

    const phoneInput = document.getElementById('PrimaryContactNumber');
    // const phoneError = document.getElementById('phone-error');

    phoneInput.addEventListener('input', function () {
      // Remove any non-numeric characters
      this.value = this.value.replace(/\D/g, '');

      // Ensure the first digit is '0'
      if (this.value.length > 0 && this.value[0] !== '0') {
        this.value = '0' + this.value;
      }

      // Limit to 10 digits
      if (this.value.length > 10) {
        this.value = this.value.substring(0, 10);
      }

      // Clear the error message when the user corrects the input
      // phoneError.textContent = '';
    });


    // For each next button, dynamically create event listeners
    for(let i = 1; i < 3; i++) {
      console.log('next' + i);
        document.getElementById('next' + i).addEventListener('click', function(e) {
            if(validatePage(i)) {
              console.log('Page validated', i);
                nextPage(i + 1);  // Proceed to the next page if validation passes
            } else {
              console.log('Page not validated');
                e.preventDefault(); // Prevent moving to the next page
                // Display error or warning message if validation fails
            }
        });
    }

    document.getElementById('tenant-application-form').addEventListener('submit', function(e){
        e.preventDefault();
        if(validatePage(3)) {
              console.log('Page validated', 3);
              // Get the current date and format it as a string
              const currentDate = new Date().toISOString();

              // Set the value of the hidden input field
              document.getElementById('currentDate').value = currentDate;

            } else {
              console.log('Page not validated');
                return;
            }

        const formData = new FormData(this);
        const formObject = {};
        formData.forEach((value, key) => {
            // Optional: Convert numeric fields to integer
            if (key === 'PrimaryContactNumber' || key === 'IdNumber') {
              if (typeof value !== 'string') {
                console.warn('PrimaryContactNumber should be a string. Converting to string.');
                value = String(value);
              }
              formObject[key] = value;
            } else {
              if (!isNaN(value)) {
                  formObject[key] = parseInt(value, 10);
              } else if (value === 'yes') { // Convert yes to true, if you have boolean fields
                  formObject[key] = true;
              } else if (value === 'no') { // Convert no to false, if you have boolean fields
                  formObject[key] = false;
              } else {
                  formObject[key] = value;
              }
            }
        });


        console.log(formObject);
        
        fetch('https://dashboard-function-app-1.azurewebsites.net/api/tenantInformation?code=oFuv1tfjDX013c_nn_mDQJm04JuxGh6A2K-TlfSaLLGAAzFu-E8pXA==', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formObject)
        })
        .then(response => {
          console.log('Raw Response:', response);
          console.log('Response Body:', response.body);
          if(response.ok) {
            const contentType = response.headers.get("content-type");
            if(contentType && contentType.indexOf("application/json") !== -1) {
              return response.json();
            } else {
              return response.text().then(text=> Promise.reject(text));
            }
          }
          throw new Error('Network response was not ok');
        })
        .then(data => {
          console.log('Success:', data);
          console.log('tenant address:', formObject['TenantAddress']);
          console.log('IdNumber:', formObject['IdNumber']);
          // After successful form submission, prepare for the new HTTP trigger
          const notificationData = {
            "recipients": [
              {
                "phone": "27785411797", // Zandi's number
                "hsm_id": "150262", // Static or dynamic value
                "parameters": [
                  {
                    "key": "{{1}}",
                    "value": formObject['TenantAddress'] // Replace with dynamic value if needed
                  },
                  {
                    "key": "{{2}}",
                    "value": formObject['FullName'] // Replace with dynamic value if needed
                  },
                  {
                    "key": "{{3}}",
                    "value": formObject['EmailAddress']
                  },
                  {
                    "key": "{{4}}",
                    "value": formObject['PrimaryContactNumber']
                  },
                  {
                    "key": "{{5}}",
                    "value": formObject['IdNumber']
                  }
                ]
              },
              {
                "phone": "27721703241", // Nolitha's number
                "hsm_id": "150262", // Static or dynamic value
                "parameters": [
                  {
                    "key": "{{1}}",
                    "value": formObject['TenantAddress'] // Replace with dynamic value if needed
                  },
                  {
                    "key": "{{2}}",
                    "value": formObject['FullName'] // Replace with dynamic value if needed
                  },
                  {
                    "key": "{{3}}",
                    "value": formObject['EmailAddress']
                  },
                  {
                    "key": "{{4}}",
                    "value": formObject['PrimaryContactNumber']
                  },
                  {
                    "key": "{{5}}",
                    "value": formObject['IdNumber']
                  }
                ]
              }
            ]
          };
          console.log('notification data:', notificationData);

          // // Send the new HTTP request
          fetch('https://dashboard-function-app-1.azurewebsites.net/api/sendWhatsappTemplate?code=HMT7Whg8vQmL9C_lOTjFZ0ILLhoLZORZXAd_myIXRdv1AzFuq4O4FQ==', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(notificationData)
          })
          .then(response => response.json()) // Handle the response
          .then(notificationResponse => {
              console.log('Notification sent:', notificationResponse);
              // Redirect after the first form submission
              window.location.href = '/success_tenant_application';
          })
          .catch(error => console.error('Notification error:', error));
        })
        .catch((error) => console.error('Error:', error));
    });


    // You might want to set up form submission logic, input validation, etc.
</script>
</body>
</html>