<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Inspection Form</title>
  <!-- Include Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Link to your custom styles.css -->
  <link rel="stylesheet" type="text/css" href="/styles.css">
  <!-- Import the Urbanist font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;600&display=swap">
</head>
<body>
  <div class="navbar">
    <button class="hamburger-icon toggle-button">
      <span class="bar"></span>
      <span class="bar"></span>
      <span class="bar"></span>
    </button>
  </div>

  <div class="sidebar">
    <div class="menu">
      <button onclick="scrollToSection('flat_section')">Flat</button>
      <button onclick="scrollToSection('bathroom_section')">Bathroom</button>
      <button onclick="scrollToSection('kitchen_section')">Kitchen</button>
      <button onclick="scrollToSection('lounge_section')">Lounge</button> 
    </div>
  </div>

  <div class="container form">
    <h2>Inspection Form</h2>
    <form action="/submit_inspection" method="POST" class="needs-validation" novalidate> 
      <!-- onsubmit="handleImageUploads()      include this at end of <form> tag in line above when processing images -->
      <div class="mb-3 section-container">
        <label for="name" class="form-label section-heading">Name:</label>
        <input type="text" id="name" name="name" class="form-control text-input" required>
      </div>
      <div class="mb-3 section-container">
        <label for="surname" class="form-label section-heading">Surname:</label>
        <input type="text" id="surname" name="surname" class="form-control text-input" required>
      </div>
      <div class="mb-3 section-container">
        <label for="phone" class="form-label section-heading">Phone Number:</label>
        <input type="tel" id="phone" name="phone" class="form-control text-input" pattern="0[0-9]{9}" placeholder="0123456789" required inputmode="numeric" minlength="10" maxlength="10">
        <p id="phone-error" class="error-message"></p>
      </div>
      <div class="mb-3 section-container">
        <label for="address" class="form-label section-heading">Address:</label>
        <input type="text" id="address" name="address" class="form-control text-input" required>
      </div>
      <div class="mb-3 section-container">
        <label for="flatLetter" class="form-label section-heading">Flat Letter:</label>
        <input type="text" id="flatLetter" name="flatLetter" class="form-control text-input" required>
      </div>

      <!-- Flat Status -->
      <div id="flat_section" class="mb-3 section-container">
        <label class="form-label section-heading">Flat Status:</label>
        <div class="status-buttons" role="group" aria-label="Flat Status">
          <input type="hidden" id="flat_status" name="flat_status" value="">
          <button id="flat_okay" type="button" class="status-button okay" onclick="updateStatus('flat', 'Okay')">Okay</button>
          <button id="flat_not-okay" type="button" class="status-button not-okay" onclick="updateStatus('flat', 'Not Okay')">Not Okay</button>
        </div>
        <input type="text" id="flat_notes" name="flat_notes" class="form-control text-input notes-text-input" placeholder="Flat Notes">
        <!-- <div id="flat_images">
          <label class="form-label section-heading">Upload Images:</label>
          <input type="file" id="flat_image" name="flat_images">
        </div> -->
      </div>

      <!-- Bathroom Status -->
      <div id="bathroom_section" class="mb-3 section-container">
        <label class="form-label section-heading">Bathroom Status:</label>
        <div class="status-buttons" role="group" aria-label="Bathroom Status">
          <input type="hidden" id="bathroom_status" name="bathroom_status" value="">
          <button id="bathroom_okay" type="button" class="status-button okay" onclick="updateStatus('bathroom', 'Okay')">Okay</button>
          <button id="bathroom_not-okay" type="button" class="status-button not-okay" onclick="updateStatus('bathroom', 'Not Okay')">Not Okay</button>
        </div>
        <input type="text" id="bathroom_notes" name="bathroom_notes" class="form-control text-input notes-text-input" placeholder="Bathroom Notes">
        <!-- <div id="bathroom_images">
          <label class="form-label section-heading">Upload Images:</label>
          <input type="file" id="bathroom_image" name="bathroom_images" >
        </div> -->
      </div>

      <!-- Kitchen Status -->
      <div id="kitchen_section" class="mb-3 section-container">
        <label class="form-label section-heading">Kitchen Status:</label>
        <div class="status-buttons" role="group" aria-label="Kitchen Status">
          <input type="hidden" id="kitchen_status" name="kitchen_status" value="">
          <button id="kitchen_okay" type="button" class="status-button okay" onclick="updateStatus('kitchen', 'Okay')">Okay</button>
          <button id="kitchen_not-okay" type="button" class="status-button not-okay" onclick="updateStatus('kitchen', 'Not Okay')">Not Okay</button>
        </div>
        <input type="text" id="kitchen_notes" name="kitchen_notes" class="form-control text-input notes-text-input" placeholder="Kitchen Notes">
        <!-- <div id="kitchen_images">
          <label class="form-label section-heading">Upload Images:</label>
          <input type="file" id="kitchen_image" name="kitchen_images">
        </div> -->
      </div>

      <!-- Lounge Status -->
      <div id="lounge_section" class="mb-3 section-container">
        <label class="form-label section-heading">Lounge Status:</label>
        <div class="status-buttons" role="group" aria-label="Lounge Status">
          <input type="hidden" id="lounge_status" name="lounge_status" value="">
          <button id="lounge_okay" type="button" class="status-button okay" onclick="updateStatus('lounge', 'Okay')">Okay</button>
          <button id="lounge_not-okay" type="button" class="status-button not-okay" onclick="updateStatus('lounge', 'Not Okay')">Not Okay</button>
        </div>
        <input type="text" id="lounge_notes" name="lounge_notes" class="form-control text-input notes-text-input" placeholder="Lounge Notes">
        <!-- <div id="lounge_images">
          <label class="form-label section-heading">Upload Images:</label>
          <input type="file"  id="lounge_image" name="lounge_images">
        </div> -->
      </div>
      <div class="mb-3 section-container">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="acknowledge" required>
          <label class="form-check-label" for="acknowledge">
            I agree that clicking 'Submit' represents my digital signature. 
            <br><br>
            Once submitted, a copy of this form will be sent to you via WhatsApp. If you have any pictures or videos related to the inspection, please send them to the WhatsApp number in the next 24 hours for them to be added to the inspection.
          </label>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Submit</button>
    </form>
    <!-- <iframe id="image_upload_frame" name="image_upload_frame" style="display: none;"></iframe> -->
  </div>

 
  <!-- Your scripts -->
  <script>
    // Run this function when the page loads
    window.onload = function() {
      updateStatus('flat', 'Okay');
      updateStatus('bathroom', 'Okay');
      updateStatus('kitchen', 'Okay');
      updateStatus('lounge', 'Okay');
    };

    function updateStatus(section, value) {
      const statusField = document.getElementById(`${section}_status`);
      const notesField = document.getElementById(`${section}_notes`);
      const okayButton = document.getElementById(`${section}_okay`);
      const notOkayButton = document.getElementById(`${section}_not-okay`);
      // const imageUploadInput = document.getElementById(`${section}_images`);
      
      statusField.value = value;
      if (value === 'Okay') {
        notesField.style.display = 'none';
        // imageUploadInput.style.display = 'none';
        okayButton.style.backgroundColor = '#221e5a';
        notOkayButton.style.backgroundColor = 'grey';
        
      } else {
        notesField.style.display = 'block';
        // imageUploadInput.style.display = 'block';
        okayButton.style.backgroundColor = 'grey';
        notOkayButton.style.backgroundColor = '#221e5a';
      }
    }

    // Toggle sidebar visibility
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('open');
    }

    // Add event listener for the hamburger icon
    document.querySelector('.toggle-button').addEventListener('click', toggleSidebar);

    // Scroll to section function
    function scrollToSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Add event listener for status change to update button styles
    document.getElementById('flat_status').addEventListener('change', function() {
      updateStatus('flat', document.getElementById('flat_status').value);
    });
    document.getElementById('bathroom_status').addEventListener('change', function() {
      updateStatus('bathroom', document.getElementById('bathroom_status').value);
    });
    document.getElementById('kitchen_status').addEventListener('change', function() {
      updateStatus('kitchen', document.getElementById('kitchen_status').value);
    });
    document.getElementById('lounge_status').addEventListener('change', function() {
      updateStatus('lounge', document.getElementById('lounge_status').value);
    });
    const checkbox = document.getElementById('acknowledge');
    const submitBtn = document.getElementById('submitBtn');

    checkbox.addEventListener('change', function () {
      submitBtn.disabled = !checkbox.checked;
    });

    function handleImageUploads() {
      console.log('handleImageUploads triggered');
    
      // Call handleImageUpload for each section
      const sections = ['flat', 'bathroom', 'kitchen', 'lounge'];
    
      for (const section of sections) {
        console.log('Section', section);
        const status = document.getElementById(`${section}_status`).value;
        const inputElement = document.getElementById(`${section}_images`).querySelector('input[type="file"]');
        console.log('inputElement:', inputElement);
        const files = inputElement ? inputElement.files : [];
        console.log('files:', files);
        if (status === 'Not Okay' && files.length > 0) {
          console.log(`Uploading image for ${section}`);

          // Update the form target to the hidden iframe
          const form = document.createElement('form');
          form.target = 'image_upload_frame'; // Set target to the iframe's name
          form.method = 'POST';
          form.action = `/upload/${section}`;
          form.enctype = 'multipart/form-data';
          
          const formData = new FormData(form);
          if (files.length > 0) {
            formData.append('images', files[0]);
            formData.append('section', section);

            // Append the form to the body and submit it
            document.body.appendChild(form);
            form.submit();
            
            // Remove the form after submission
            form.remove();
          } else {
            console.log(`Skipping ${section} image upload`);
          }
        }
      
        // Return false to prevent default form submission behavior
        return false;
      }
    }
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phone-error');
    const submitButton = document.getElementById('submit-button');

    phoneInput.addEventListener('input', function () {
      // Remove any non-numeric characters
      this.value = this.value.replace(/\D/g, '');

      // Ensure the first digit is '0'
      if (this.value.length > 0 && this.value[0] !== '0') {
        this.value = '0' + this.value;
      }

      // Limit to 10 digits
      if (this.value.length > 10) {
        this.value = this.value.substring(0, 10);
      }

      // Clear the error message when the user corrects the input
      phoneError.textContent = '';
    });

    // Add form submission event listener
    document.querySelector('form').addEventListener('submit', function (e) {
      if (phoneInput.value.length !== 10) {
        e.preventDefault(); // Prevent form submission
        phoneInput.style.borderColor = 'red'; // Highlight the field in red
        phoneError.textContent = 'Invalid phone number'; // Display error message
      }
    });
  </script>
  
  <!-- <script src="path/to/initializeSidebar.js"></script> -->
</body>
</html>